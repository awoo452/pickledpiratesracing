<section class="product-show">

  <div class="product-show-card">

    <h1><%= @product.name %></h1>

    <% if @product.image.present? %>
      <%= image_tag @product.image, alt: @product.name, class: "product-show-image" %>
    <% end %>

    <p class="product-description"><%= @product.description %></p>

    <% if @variants.any? %>
      <div class="variant-selector">
        <label for="variant_id">Choose option</label>

        <select id="variant_id">
          <% @variants.each do |variant| %>
            <option
              value="<%= variant.id %>"
              data-price="<%= variant.price_override.nil? ? @product.price : variant.price_override %>">
              <%= variant.name %>
              <% if variant.stock.present? %> (<%= variant.stock %> left)<% end %>
            </option>
          <% end %>
        </select>
      </div>
    <% end %>


    <p class="product-price">
      $<span id="display-price"><%= number_with_precision(@product.price, precision: 2) %></span>
    </p>

    <div class="paypal-container" data-turbo="false">
      <div id="paypal-button-container"></div>
    </div>

    <%= link_to "Back to products", products_path, class: "back-link", data: { turbo: false } %>

  </div>

</section>

<script>
  let paypalRendered = false;

  function selectedVariant() {
    const el = document.getElementById("variant_id");
    if (!el) return null;

    const opt = el.options[el.selectedIndex];
    return {
      id: opt.value,
      price: opt.dataset.price
    };
  }

  function updateDisplayedPrice() {
    const variant = selectedVariant();
    if (!variant) return;

    const priceEl = document.getElementById("display-price");
    if (!priceEl) return;

    priceEl.textContent = parseFloat(variant.price).toFixed(2);
  }

  function renderPaypalButton() {
    if (paypalRendered) return;
    if (!window.paypal) return setTimeout(renderPaypalButton, 300);

    paypalRendered = true;

    paypal.Buttons({
      createOrder: function(data, actions) {
        const variant = selectedVariant();

        return actions.order.create({
          purchase_units: [{
            amount: {
              value: variant ? variant.price : "<%= @product.price %>"
            }
          }]
        });
      },

      onApprove: function(data, actions) {
        const variant = selectedVariant();

        return actions.order.capture().then(function(details) {
          console.log("variant_id:", variant?.id);
          alert("Payment completed by " + details.payer.name.given_name);
        });
      }
    }).render("#paypal-button-container");
  }

  document.addEventListener("change", function(e) {
    if (e.target && e.target.id === "variant_id") {
      updateDisplayedPrice();
    }
  });

  function initProductPage() {
    renderPaypalButton();
    updateDisplayedPrice();
  }

  document.addEventListener("DOMContentLoaded", initProductPage);
  document.addEventListener("turbo:load", initProductPage);
</script>
