<% content_for :head do %>
  <meta name="turbo-visit-control" content="reload">
  <% if ENV["PAYPAL_CLIENT_ID"].present? %>
    <script
      src="https://www.paypal.com/sdk/js?client-id=<%= ENV["PAYPAL_CLIENT_ID"] %>&currency=USD&intent=capture"
      data-turbo-track="reload"></script>
  <% end %>
<% end %>

<section class="product-show">
  <div class="product-show-card">

    <h1><%= @product.name %></h1>

    <% if @product.image_key.present? %>
      <% @product.image_variants.each do |img| %>
        <% proxy_url = image_proxy_url(img[:key], width: 900, height: 900, fit: "inside", format: "webp") || img[:url] %>
        <img
          src="<%= proxy_url %>"
          class="product-main-image"
          loading="lazy"
        >
      <% end %>
    <% end %>

    <p class="product-description"><%= @product.description %></p>

    <% available_variants = @variants.select { |v| v.stock.present? && v.stock > 0 } %>

    <% if @variants.any? %>
      <div class="variant-selector">
        <label for="variant_id">Choose option</label>

        <select id="variant_id">
          <% @variants.each do |variant| %>
            <% out_of_stock = variant.stock.blank? || variant.stock <= 0 %>
            <option
              value="<%= variant.id %>"
              data-price="<%= variant.price_override.nil? ? @product.price : variant.price_override %>"
              <%= "disabled" if out_of_stock %>>
              <%= variant.name %>
              <% if out_of_stock %>
                (Sold out)
              <% elsif variant.stock.present? %>
                (<%= variant.stock %> left)
              <% end %>
            </option>
          <% end %>
        </select>
      </div>
    <% end %>

    <% if @product.price_hidden? %>
      <p class="product-price">Coming Soon</p>
    <% elsif @variants.any? && available_variants.empty? %>
      <p class="product-price">Sold Out</p>
    <% elsif @variants.none? %>
      <p class="product-price">No options available</p>
    <% else %>
      <p class="product-price">
        $<span id="display-price"><%= number_with_precision(@product.price, precision: 2) %></span>
      </p>

      <div
        class="paypal-container"
        data-turbo="false"
        data-controller="paypal"
        data-paypal-client-id-value="<%= ENV["PAYPAL_CLIENT_ID"] %>"
        data-paypal-product-id-value="<%= @product.id %>"
        data-paypal-variant-select-id-value="variant_id"
        data-paypal-currency-value="USD">
        <div id="paypal-button-container" data-paypal-target="buttons"></div>
        <p class="paypal-status" data-paypal-target="status" aria-live="polite"></p>
      </div>
    <% end %>

    <%= link_to "Back to products", products_path,
          class: "back-link",
          data: { turbo: false } %>

  </div>
</section>
